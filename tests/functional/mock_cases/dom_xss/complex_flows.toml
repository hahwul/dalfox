# DOM XSS test cases with complex data flows
# These test cases focus on multi-step taint propagation

[[case]]
id = 1301
name = "multi_variable_assignment"
description = "Taint flow through multiple variable assignments"
handler_type = "dom_xss"
reflection = """
<html>
<body>
<div id="output"></div>
<script>
var a = location.search;
var b = a.substring(1);
var c = b.split('=')[1];
var d = decodeURIComponent(c);
document.getElementById('output').innerHTML = d;
</script>
</body>
</html>
"""
expected_detection = true

[[case]]
id = 1302
name = "function_parameter_taint"
description = "Taint flow through function parameters"
handler_type = "dom_xss"
reflection = """
<html>
<body>
<div id="display"></div>
<script>
function render(content) {
  document.getElementById('display').innerHTML = content;
}

var param = location.hash.substring(1);
render(param);
</script>
</body>
</html>
"""
expected_detection = true

[[case]]
id = 1303
name = "object_property_taint"
description = "Taint flow through object properties"
handler_type = "dom_xss"
reflection = """
<html>
<body>
<div id="content"></div>
<script>
var config = {
  data: location.search.substring(1)
};
document.getElementById('content').innerHTML = config.data;
</script>
</body>
</html>
"""
expected_detection = true

[[case]]
id = 1304
name = "array_element_taint"
description = "Taint flow through array elements"
handler_type = "dom_xss"
reflection = """
<html>
<body>
<div id="item"></div>
<script>
var items = [];
items.push(location.hash);
items.push('safe');
document.getElementById('item').innerHTML = items[0];
</script>
</body>
</html>
"""
expected_detection = true

[[case]]
id = 1305
name = "template_literal_taint"
description = "Taint flow through template literals"
handler_type = "dom_xss"
reflection = """
<html>
<body>
<div id="message"></div>
<script>
var user = location.search.split('user=')[1];
var greeting = `Hello ${user}!`;
document.getElementById('message').innerHTML = greeting;
</script>
</body>
</html>
"""
expected_detection = true

[[case]]
id = 1306
name = "conditional_taint_flow"
description = "Taint flow through conditional statements"
handler_type = "dom_xss"
reflection = """
<html>
<body>
<div id="result"></div>
<script>
var input = location.search;
var output;
if (input.length > 0) {
  output = input.substring(1);
} else {
  output = 'default';
}
document.getElementById('result').innerHTML = output;
</script>
</body>
</html>
"""
expected_detection = true

[[case]]
id = 1307
name = "loop_taint_propagation"
description = "Taint flow through loop iterations"
handler_type = "dom_xss"
reflection = """
<html>
<body>
<div id="list"></div>
<script>
var params = location.search.substring(1).split('&');
var result = '';
for (var i = 0; i < params.length; i++) {
  result += params[i] + '<br>';
}
document.getElementById('list').innerHTML = result;
</script>
</body>
</html>
"""
expected_detection = true

[[case]]
id = 1308
name = "assignment_in_if_branch"
description = "Taint propagated via assignment inside if branch"
handler_type = "dom_xss"
reflection = """
<html>
<body>
<div id="out"></div>
<script>
var source = location.hash;
var out = "safe";
if (source) {
  out = source;
}
document.getElementById('out').innerHTML = out;
</script>
</body>
</html>
"""
expected_detection = true

[[case]]
id = 1309
name = "array_push_then_index_sink"
description = "Taint flow through array push then indexed access"
handler_type = "dom_xss"
reflection = """
<html>
<body>
<script>
var arr = [];
arr.push(location.search);
document.write(arr[0]);
</script>
</body>
</html>
"""
expected_detection = true

[[case]]
id = 1310
name = "array_splice_then_sink"
description = "Taint flow through array splice inserted value"
handler_type = "dom_xss"
reflection = """
<html>
<body>
<script>
var arr = ["safe"];
arr.splice(0, 1, location.hash);
document.write(arr[0]);
</script>
</body>
</html>
"""
expected_detection = true

[[case]]
id = 1311
name = "array_unshift_then_sink"
description = "Taint flow through array unshift"
handler_type = "dom_xss"
reflection = """
<html>
<body>
<script>
var list = ["x"];
list.unshift(location.search);
document.write(list[0]);
</script>
</body>
</html>
"""
expected_detection = true

[[case]]
id = 1312
name = "switch_branch_assignment"
description = "Taint assigned in switch branch then used in sink"
handler_type = "dom_xss"
reflection = """
<html>
<body>
<div id="box"></div>
<script>
var data = location.hash;
var output = "safe";
switch (data) {
  default:
    output = data;
}
document.getElementById('box').innerHTML = output;
</script>
</body>
</html>
"""
expected_detection = true

[[case]]
id = 1313
name = "try_catch_assignment_flow"
description = "Taint assignment inside try block then sink usage"
handler_type = "dom_xss"
reflection = """
<html>
<body>
<script>
var out = "safe";
try {
  out = location.search;
} catch (e) {}
document.write(out);
</script>
</body>
</html>
"""
expected_detection = true

[[case]]
id = 1314
name = "logical_chain_assignment_flow"
description = "Taint through logical expression and assignment chain"
handler_type = "dom_xss"
reflection = """
<html>
<body>
<div id="target"></div>
<script>
var base = location.search || "";
var out = "prefix:" + base;
document.getElementById('target').innerHTML = out;
</script>
</body>
</html>
"""
expected_detection = true

[[case]]
id = 1315
name = "tainted_get_call_from_urlsearchparams"
description = "Tainted URLSearchParams.get result to sink"
handler_type = "dom_xss"
reflection = """
<html>
<body>
<script>
var params = new URL(location.href).searchParams;
var value = params.get('id');
document.write(value);
</script>
</body>
</html>
"""
expected_detection = true

[[case]]
id = 1316
name = "json_parse_then_reassign"
description = "JSON.parse of tainted value then reassigned to sink variable"
handler_type = "dom_xss"
reflection = """
<html>
<body>
<div id="render"></div>
<script>
var raw = location.hash;
var obj = JSON.parse(raw);
var out = "safe";
out = obj;
document.getElementById('render').innerHTML = out;
</script>
</body>
</html>
"""
expected_detection = true

[[case]]
id = 1317
name = "sequence_expression_then_sink"
description = "Taint through sequence expression into sink"
handler_type = "dom_xss"
reflection = """
<html>
<body>
<script>
var value = (1, 2, location.search);
document.write(value);
</script>
</body>
</html>
"""
expected_detection = true

[[case]]
id = 1318
name = "object_spread_then_innerhtml"
description = "Taint through object spread followed by innerHTML sink"
handler_type = "dom_xss"
reflection = """
<html>
<body>
<div id="o"></div>
<script>
var src = { payload: location.hash };
var dst = { ...src };
document.getElementById('o').innerHTML = dst.payload;
</script>
</body>
</html>
"""
expected_detection = true

[[case]]
id = 1319
name = "template_literal_reassignment_chain"
description = "Template literal taint stored in variable chain then sink"
handler_type = "dom_xss"
reflection = """
<html>
<body>
<script>
var p = location.search;
var x = `<b>${p}</b>`;
var y = x;
document.write(y);
</script>
</body>
</html>
"""
expected_detection = true

[[case]]
id = 1320
name = "computed_member_from_tainted_array"
description = "Computed member access from tainted array to sink"
handler_type = "dom_xss"
reflection = """
<html>
<body>
<script>
var arr = [location.hash, "safe"];
var idx = 0;
document.write(arr[idx]);
</script>
</body>
</html>
"""
expected_detection = true

[[case]]
id = 1321
name = "function_param_to_innerhtml"
description = "Tainted argument passed into helper function sink"
handler_type = "dom_xss"
reflection = """
<html>
<body>
<div id="display"></div>
<script>
function render(content) {
  document.getElementById('display').innerHTML = content;
}
var p = location.hash.substring(1);
render(p);
</script>
</body>
</html>
"""
expected_detection = true

[[case]]
id = 1322
name = "function_hoisted_call_to_document_write"
description = "Function called before declaration with tainted argument"
handler_type = "dom_xss"
reflection = """
<html>
<body>
<script>
var p = location.search;
sinkWrap(p);
function sinkWrap(v) {
  document.write(v);
}
</script>
</body>
</html>
"""
expected_detection = true

[[case]]
id = 1323
name = "function_two_params_second_tainted"
description = "Second function argument tainted and used in sink"
handler_type = "dom_xss"
reflection = """
<html>
<body>
<div id="out"></div>
<script>
function show(prefix, value) {
  document.getElementById('out').innerHTML = prefix + value;
}
var tainted = location.hash;
show('x:', tainted);
</script>
</body>
</html>
"""
expected_detection = true

[[case]]
id = 1324
name = "function_with_branch_assignment_and_sink"
description = "Tainted parameter assigned in branch and then used in sink"
handler_type = "dom_xss"
reflection = """
<html>
<body>
<script>
function wrap(v) {
  var out = "safe";
  if (v) {
    out = v;
  }
  eval(out);
}
wrap(location.search);
</script>
</body>
</html>
"""
expected_detection = true

[[case]]
id = 1325
name = "function_return_source_to_sink"
description = "Function returns source directly and result is sent to sink"
handler_type = "dom_xss"
reflection = """
<html>
<body>
<script>
function getPayload() {
  return location.hash;
}
document.write(getPayload());
</script>
</body>
</html>
"""
expected_detection = true

[[case]]
id = 1326
name = "function_expression_param_to_sink"
description = "Function expression parameter flows to sink"
handler_type = "dom_xss"
reflection = """
<html>
<body>
<div id="display"></div>
<script>
var render = function (content) {
  document.getElementById('display').innerHTML = content;
};
var input = location.search;
render(input);
</script>
</body>
</html>
"""
expected_detection = true

[[case]]
id = 1327
name = "arrow_function_param_to_sink"
description = "Arrow function parameter flows to sink"
handler_type = "dom_xss"
reflection = """
<html>
<body>
<div id="display"></div>
<script>
var render = (content) => {
  document.getElementById('display').innerHTML = content;
};
var input = location.hash;
render(input);
</script>
</body>
</html>
"""
expected_detection = true

[[case]]
id = 1328
name = "computed_assignment_then_sink"
description = "Computed member assignment propagates taint to sink"
handler_type = "dom_xss"
reflection = """
<html>
<body>
<script>
var arr = [];
arr[0] = location.search;
document.write(arr[0]);
</script>
</body>
</html>
"""
expected_detection = true

[[case]]
id = 1329
name = "named_message_handler_to_sink"
description = "Named message event callback routes event.data to sink"
handler_type = "dom_xss"
reflection = """
<html>
<body>
<div id="out"></div>
<script>
function onMessage(event) {
  document.getElementById('out').innerHTML = event.data;
}
window.addEventListener('message', onMessage);
</script>
</body>
</html>
"""
expected_detection = true

[[case]]
id = 1330
name = "source_return_chain_assignment"
description = "Tainted return value assigned through chain before sink"
handler_type = "dom_xss"
reflection = """
<html>
<body>
<script>
function readInput() {
  return location.search;
}
var a = readInput();
var b = a;
eval(b);
</script>
</body>
</html>
"""
expected_detection = true

[[case]]
id = 1331
name = "object_property_assignment_then_sink"
description = "Object property assignment from source flows to sink"
handler_type = "dom_xss"
reflection = """
<html>
<body>
<script>
var model = {};
model.html = location.hash;
document.write(model.html);
</script>
</body>
</html>
"""
expected_detection = true

[[case]]
id = 1332
name = "computed_innerhtml_assignment"
description = "Computed member innerHTML assignment from source"
handler_type = "dom_xss"
reflection = """
<html>
<body>
<div id="out"></div>
<script>
var payload = location.hash;
var el = document.getElementById('out');
el['innerHTML'] = payload;
</script>
</body>
</html>
"""
expected_detection = true

[[case]]
id = 1333
name = "computed_location_href_assignment"
description = "Computed location.href assignment sink"
handler_type = "dom_xss"
reflection = """
<html>
<body>
<script>
var target = location.search;
location['href'] = target;
</script>
</body>
</html>
"""
expected_detection = true

[[case]]
id = 1334
name = "computed_document_write_call"
description = "Computed member document.write sink call"
handler_type = "dom_xss"
reflection = """
<html>
<body>
<script>
var data = location.hash;
document['write'](data);
</script>
</body>
</html>
"""
expected_detection = true

[[case]]
id = 1335
name = "computed_insertadjacenthtml_call"
description = "Computed member insertAdjacentHTML sink call"
handler_type = "dom_xss"
reflection = """
<html>
<body>
<div id="out"></div>
<script>
var data = location.search;
var el = document.getElementById('out');
el['insertAdjacentHTML']('beforeend', data);
</script>
</body>
</html>
"""
expected_detection = true

[[case]]
id = 1336
name = "computed_storage_getitem_to_sink"
description = "Computed storage getItem source call to sink"
handler_type = "dom_xss"
reflection = """
<html>
<body>
<script>
var data = localStorage['getItem']('payload');
document.write(data);
</script>
</body>
</html>
"""
expected_detection = true

[[case]]
id = 1337
name = "sink_call_wrapper"
description = "Sink invoked via Function.call wrapper"
handler_type = "dom_xss"
reflection = """
<html>
<body>
<script>
var input = location.hash;
document.write.call(document, input);
</script>
</body>
</html>
"""
expected_detection = true

[[case]]
id = 1338
name = "sink_apply_wrapper"
description = "Sink invoked via Function.apply wrapper"
handler_type = "dom_xss"
reflection = """
<html>
<body>
<script>
document.write.apply(document, [location.search]);
</script>
</body>
</html>
"""
expected_detection = true

[[case]]
id = 1339
name = "bound_sink_alias_call"
description = "Bound sink alias later invoked with tainted data"
handler_type = "dom_xss"
reflection = """
<html>
<body>
<script>
var writer = document.write.bind(document);
var payload = location.hash;
writer(payload);
</script>
</body>
</html>
"""
expected_detection = true

[[case]]
id = 1340
name = "object_literal_method_summary_flow"
description = "Object literal method receives tainted argument and uses sink"
handler_type = "dom_xss"
reflection = """
<html>
<body>
<div id="out"></div>
<script>
var helper = {
  render(value) {
    document.getElementById('out').innerHTML = value;
  }
};
helper.render(location.hash);
</script>
</body>
</html>
"""
expected_detection = true

[[case]]
id = 1341
name = "class_instance_method_summary_flow"
description = "Class instance method receives tainted value and uses sink"
handler_type = "dom_xss"
reflection = """
<html>
<body>
<script>
class Renderer {
  render(value) {
    document.write(value);
  }
}
var r = new Renderer();
r.render(location.search);
</script>
</body>
</html>
"""
expected_detection = true

[[case]]
id = 1342
name = "class_static_method_summary_flow"
description = "Class static method receives tainted value and uses sink"
handler_type = "dom_xss"
reflection = """
<html>
<body>
<script>
class Redirector {
  static go(url) {
    location.assign(url);
  }
}
Redirector.go(location.hash);
</script>
</body>
</html>
"""
expected_detection = true

[[case]]
id = 1343
name = "summary_call_wrapper_flow"
description = "Function summary flow through call wrapper"
handler_type = "dom_xss"
reflection = """
<html>
<body>
<script>
function render(value) {
  document.write(value);
}
render.call(null, location.hash);
</script>
</body>
</html>
"""
expected_detection = true

[[case]]
id = 1344
name = "summary_apply_wrapper_flow"
description = "Function summary flow through apply wrapper"
handler_type = "dom_xss"
reflection = """
<html>
<body>
<script>
function render(value) {
  document.write(value);
}
render.apply(null, [location.search]);
</script>
</body>
</html>
"""
expected_detection = true

[[case]]
id = 1345
name = "bound_object_method_summary_flow"
description = "Bound object method summary invoked with tainted value"
handler_type = "dom_xss"
reflection = """
<html>
<body>
<script>
var helper = {
  render(v) {
    eval(v);
  }
};
var bound = helper.render.bind(helper);
bound(location.search);
</script>
</body>
</html>
"""
expected_detection = true

[[case]]
id = 1346
name = "dynamic_setattribute_name_concat"
description = "setAttribute dangerous name built via string concatenation"
handler_type = "dom_xss"
reflection = """
<html>
<body>
<div id="x"></div>
<script>
var input = location.hash;
document.getElementById('x').setAttribute('on' + 'click', input);
</script>
</body>
</html>
"""
expected_detection = true

[[case]]
id = 1347
name = "dynamic_execcommand_name_concat"
description = "execCommand insertHTML name built via concatenation"
handler_type = "dom_xss"
reflection = """
<html>
<body>
<script>
var html = location.search;
document.execCommand('insert' + 'HTML', false, html);
</script>
</body>
</html>
"""
expected_detection = true

[[case]]
id = 1348
name = "bound_source_alias_to_sink"
description = "Bound source helper result flows into sink"
handler_type = "dom_xss"
reflection = """
<html>
<body>
<script>
var readStorage = localStorage.getItem.bind(localStorage);
var data = readStorage('payload');
document.write(data);
</script>
</body>
</html>
"""
expected_detection = true

[[case]]
id = 1349
name = "bound_summary_prebound_tainted_arg"
description = "Function summary with tainted pre-bound argument reaches sink"
handler_type = "dom_xss"
reflection = """
<html>
<body>
<script>
function render(value) {
  document.write(value);
}
var bound = render.bind(null, location.hash);
bound();
</script>
</body>
</html>
"""
expected_detection = true

[[case]]
id = 1350
name = "bound_sink_prebound_tainted_arg"
description = "Sink alias with tainted pre-bound argument should be detected"
handler_type = "dom_xss"
reflection = """
<html>
<body>
<script>
var writer = document.write.bind(document, location.search);
writer();
</script>
</body>
</html>
"""
expected_detection = true

[[case]]
id = 1351
name = "bound_object_method_prebound_tainted_arg"
description = "Bound object method with tainted pre-bound argument reaches sink"
handler_type = "dom_xss"
reflection = """
<html>
<body>
<script>
var helper = {
  render(v) {
    eval(v);
  }
};
var bound = helper.render.bind(helper, location.hash);
bound();
</script>
</body>
</html>
"""
expected_detection = true

[[case]]
id = 1352
name = "bound_return_prebound_arg_to_sink"
description = "Return value taint through pre-bound argument flows into sink"
handler_type = "dom_xss"
reflection = """
<html>
<body>
<script>
function echo(v) {
  return v;
}
var f = echo.bind(null, location.search);
document.write(f());
</script>
</body>
</html>
"""
expected_detection = true

[[case]]
id = 1353
name = "computed_sink_property_concat"
description = "Computed sink name via string concat should resolve to document.write"
handler_type = "dom_xss"
reflection = """
<html>
<body>
<script>
var payload = location.hash;
document['wri' + 'te'](payload);
</script>
</body>
</html>
"""
expected_detection = true

[[case]]
id = 1354
name = "computed_wrapper_property_concat"
description = "Computed wrapper property concat should detect document.write.call pattern"
handler_type = "dom_xss"
reflection = """
<html>
<body>
<script>
var payload = location.search;
document.write['ca' + 'll'](document, payload);
</script>
</body>
</html>
"""
expected_detection = true

[[case]]
id = 1355
name = "bind_chain_sink_alias"
description = "Chained bind aliases should preserve tainted pre-bound arguments"
handler_type = "dom_xss"
reflection = """
<html>
<body>
<script>
var base = document.write.bind(document, location.hash);
var chained = base.bind(null);
chained();
</script>
</body>
</html>
"""
expected_detection = true

[[case]]
id = 1356
name = "bound_sink_alias_call_wrapper"
description = "Bound sink alias invoked through call wrapper should be detected"
handler_type = "dom_xss"
reflection = """
<html>
<body>
<script>
var writer = document.write.bind(document);
writer.call(null, location.hash);
</script>
</body>
</html>
"""
expected_detection = true

[[case]]
id = 1357
name = "bound_sink_alias_apply_wrapper"
description = "Bound sink alias invoked through apply wrapper should be detected"
handler_type = "dom_xss"
reflection = """
<html>
<body>
<script>
var writer = document.write.bind(document);
writer.apply(null, [location.search]);
</script>
</body>
</html>
"""
expected_detection = true

[[case]]
id = 1358
name = "summary_apply_wrapper_param_index"
description = "Function.apply should map tainted argument to the correct sink parameter index"
handler_type = "dom_xss"
reflection = """
<html>
<body>
<script>
function render(a, b) {
  document.write(b);
}
render.apply(null, ['safe', location.hash]);
</script>
</body>
</html>
"""
expected_detection = true

[[case]]
id = 1359
name = "bound_summary_call_wrapper"
description = "Bound summary alias invoked through call wrapper should be detected"
handler_type = "dom_xss"
reflection = """
<html>
<body>
<script>
function render(v) {
  eval(v);
}
var bound = render.bind(null);
bound.call(null, location.search);
</script>
</body>
</html>
"""
expected_detection = true

[[case]]
id = 1360
name = "bound_summary_apply_prebound_index"
description = "Bound summary apply should account for pre-bound argument offsets"
handler_type = "dom_xss"
reflection = """
<html>
<body>
<script>
function render(a, b) {
  document.write(b);
}
var bound = render.bind(null, 'safe');
bound.apply(null, [location.hash]);
</script>
</body>
</html>
"""
expected_detection = true

[[case]]
id = 1361
name = "reflect_apply_document_write"
description = "Reflect.apply invocation of document.write with tainted argument"
handler_type = "dom_xss"
reflection = """
<html>
<body>
<script>
Reflect.apply(document.write, document, [location.hash]);
</script>
</body>
</html>
"""
expected_detection = true

[[case]]
id = 1362
name = "reflect_apply_bound_sink_alias"
description = "Reflect.apply invocation of bound sink alias with tainted argument"
handler_type = "dom_xss"
reflection = """
<html>
<body>
<script>
var writer = document.write.bind(document);
Reflect.apply(writer, null, [location.search]);
</script>
</body>
</html>
"""
expected_detection = true

[[case]]
id = 1363
name = "reflect_apply_summary_flow"
description = "Reflect.apply should respect function summary sink flow"
handler_type = "dom_xss"
reflection = """
<html>
<body>
<script>
function render(v) {
  eval(v);
}
Reflect.apply(render, null, [location.hash]);
</script>
</body>
</html>
"""
expected_detection = true

[[case]]
id = 1364
name = "reflect_apply_source_return_to_sink"
description = "Reflect.apply source return value should propagate taint to sink"
handler_type = "dom_xss"
reflection = """
<html>
<body>
<script>
var value = Reflect.apply(localStorage.getItem, localStorage, ['payload']);
document.write(value);
</script>
</body>
</html>
"""
expected_detection = true

[[case]]
id = 1365
name = "reflect_apply_setattribute_dangerous"
description = "Reflect.apply setAttribute with dangerous attribute should be detected"
handler_type = "dom_xss"
reflection = """
<html>
<body>
<div id="x"></div>
<script>
var el = document.getElementById('x');
Reflect.apply(el.setAttribute, el, ['onclick', location.hash]);
</script>
</body>
</html>
"""
expected_detection = true

[[case]]
id = 1366
name = "reflect_apply_execcommand_inserthtml"
description = "Reflect.apply execCommand insertHTML should be detected"
handler_type = "dom_xss"
reflection = """
<html>
<body>
<script>
Reflect.apply(document.execCommand, document, ['insertHTML', false, location.search]);
</script>
</body>
</html>
"""
expected_detection = true

[[case]]
id = 1367
name = "reflect_construct_function_tainted"
description = "Reflect.construct Function with tainted code should be detected"
handler_type = "dom_xss"
reflection = """
<html>
<body>
<script>
Reflect.construct(Function, [location.hash]);
</script>
</body>
</html>
"""
expected_detection = true

[[case]]
id = 1368
name = "reflect_apply_insertadjacenthtml_tainted"
description = "Reflect.apply insertAdjacentHTML with tainted html argument should be detected"
handler_type = "dom_xss"
reflection = """
<html>
<body>
<div id="x"></div>
<script>
var el = document.getElementById('x');
Reflect.apply(el.insertAdjacentHTML, el, ['beforeend', location.search]);
</script>
</body>
</html>
"""
expected_detection = true
